# SoftValidator

[![Continuous Integration](https://github.com/bdurand/soft_validator/actions/workflows/continuous_integration.yml/badge.svg)](https://github.com/bdurand/soft_validator/actions/workflows/continuous_integration.yml)
[![Regression Test](https://github.com/bdurand/soft_validator/actions/workflows/regression_test.yml/badge.svg)](https://github.com/bdurand/soft_validator/actions/workflows/regression_test.yml)
[![Ruby Style Guide](https://img.shields.io/badge/code_style-standard-brightgreen.svg)](https://github.com/testdouble/standard)
[![Gem Version](https://badge.fury.io/rb/soft_validator.svg)](https://badge.fury.io/rb/soft_validator)

This gem adds a soft validator for use with ActiveModel/ActiveRecord. It is intended to solve issues that can arise when adding new validations to an existing model. Once your model is running in production and you add a new validation, you can't always be sure that there is no code path that would fail with the new validation.

The soft validator can execise the new validation logic but, rather than generating errors, it will generate notifications. This allows you to add new validations to a model without breaking existing code and lets you know what code or processes need to be fixed before enforcing the new validation.

## Usage

The easiest way to use the gem is simply to wrap your existing validations with a `:soft` option.

```ruby
class Thing < ApplicationRecord
  validates :units, presence: true, soft: {inclusion: {in: %w(feet meters)}}
end
```

This will run the inclusion validation on the model. However, if there are any errors, they will not be added to the record errors and the record will still be considered valid.

Soft validation errors are published via ActiveSupport notifications. You can subscribe to the `soft_validator.error` event to handle the errors generated by soft validations. For instance, you could log the errors to the Rails logger by adding this code to an initializer:

```ruby
ActiveSupport::Notifications.subscribe("validation_error.soft_validator") do |event|
  error = event.payload[:error]
  message = "Soft validation error on {error.base.class.name}(#{error.base.id}): #{error.full_message}"
  Rails.logger.warn(message)
end
```

You can also the `SoftValidator.subscribe` helper method to set up subscriptions if you just want to get the error:

```ruby
SoftValidator.subscribe do |error|
  message = "Soft validation error on {error.base.class.name}(#{error.base.id}): #{error.full_message}"
  Rails.logger.warn(message)
end
```

NOTE: in a Rails environment you **do not** need to set up a subscription in order to log errors; one will be set up for you automatically. You can disable this behavior by calling `SoftValidator::LogSubscriber.detach`.

You can turn a soft validation into a hard validation by setting the `:enforce` option to `true`. This will cause the validation to generate errors as normal. You can use this feature to turn the validaton on with a feature flag.

```ruby
class Thing < ApplicationRecord
  validates :units,
            presence: true,
            soft: {
              inclusion: {in: %w(feet meters)},
              enforce: ENV.fetch("ENFORCE_UNITS", !Rails.env.production?.to_s) == "true"
            }
end
```

You can set the global default for enforcing all soft validations by setting the `SoftValidator.enforce`  to `true`. This will cause all soft validations to generate errors by default. This is automatically set in a Rails application in the development and test environments since you would typically want to see the errors in those environments so that you can fix them.

If you want to add any of the standard options for the validator (i.e. `:if`, `:unless`, `:on`, `:prepend`), you need to add it to the soft validator and not the wrapped validator.

```ruby
class Thing < ApplicationRecord
  validates :units, soft: {inclusion: {in: %w(feet meters)}, if: :email_changed?}

  # This won't work; the `if` option cannot be on the wrapped validator:
  # validates :units, soft: {inclusion: {in: %w(feet meters), if: :email_changed?}}
end
```

## Installation

Add this line to your application's Gemfile:

```ruby
gem "soft_validator"
```

Then execute:
```bash
$ bundle
```

Or install it yourself as:
```bash
$ gem install gem "soft_validator"
```

## Contributing

Open a pull request on GitHub.

Please use the [standardrb](https://github.com/testdouble/standard) syntax and lint your code with `standardrb --fix` before submitting.

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
